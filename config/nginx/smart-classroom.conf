# 定義 Captive Portal 的核心攔截邏輯
server {
    listen 80;
    server_name _;  # 監聽所有網域名稱

    # --- 1. 勸導頁面 (白名單) ---
    location /portal {
        alias /var/www/portal;
        index index.html;
        # 確保找不到檔案時回到 index.html (SPA 常見設定)
        try_files $uri $uri/ /index.html;
        # 禁止快取，方便開發除錯
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # --- 2. 老師後台 (白名單) ---
    location /teacher {
        alias /var/www/portal/teacher.html;
        default_type text/html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    
    # --- 3. API Proxy (FastAPI Backend / 白名單) ---
    # 將 API 請求轉發給後端
    location /api {
        proxy_pass http://127.0.0.1:8000;
        
        # 設定轉發 Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 如果有從 Nginx 取得 MAC (透過 arp 模組或其他方式)，可以在這裡帶入
        # 如果沒有，組員的程式碼是透過「學號登入」來識別的，這也沒問題
        proxy_set_header X-Mac-Address $http_x_mac_address;
    }

    # --- 4. 模擬外部網路 (白名單) 測試用 ---
    # 當學生解鎖成功後，JS 會將他導向這裡，代表「我自由了」
    # 真實，防火牆放行後，學生請求這頁會直接穿過 Nginx 去真的 Google
    location /internet {
        alias /var/www/portal/target.html;
        default_type text/html;
    }
    
    # --- 5. 強制攔截 (Captive Portal Logic) ---
    # 所有不符合上述白名單的請求，通通抓進來
    # 情境 A：學生違規被斷網，輸入 google.com -> 這裡攔截 -> 轉去 /portal
    # 情境 B：學生輸入 pornhub.com (透過 DNS 欺騙) -> 這裡攔截 -> 轉去 /portal
    location / {
        # 產生 302 轉址
        # 參數說明：
        # original_url：使用者原本想去的網址
        # mac：嘗試從 HTTP Header 讀取 MAC
        return 302 http://$host/portal?original_url=$scheme://$http_host$request_uri&mac=$http_x_mac_address;
    }
}
