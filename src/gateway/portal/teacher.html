<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Flow - æ™ºæ…§æ•™å­¸ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#F0F5FA', 100: '#E0EBF5', 500: '#4A6FA5', 600: '#3D5C8A', 700: '#2F486B' },
                        cream: { 50: '#FCFAF6', 100: '#F9F6F0', 200: '#F4EDE2', 300: '#EBE0D0' },
                        sakura: { 100: '#FDF2F0', 500: '#EBAA99', 600: '#D98E7D' },
                        success: { 50: '#F2F9F6', 500: '#5BA890', 600: '#468C75' },
                        gray: { 50: '#F9F9F9', 100: '#F0F0F0', 200: '#E6E6E6', 300: '#D4D4D4', 400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151', 800: '#1F2937', 900: '#111827' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(74, 111, 165, 0.1)', 'card': '0 1px 3px 0 rgba(0, 0, 0, 0.05)' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.5s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F9F9F9; color: #374151; font-family: 'Noto Sans TC', sans-serif; font-size: 16px; letter-spacing: 0.01em; line-height: 1.6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        [v-cloak] { display: none; }
        .spinner { width: 20px; height: 20px; border: 2.5px solid #E0EBF5; border-top-color: #4A6FA5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        input:focus { outline: none; border-color: #4A6FA5; box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.15); }
        td, th { padding-top: 1rem; padding-bottom: 1rem; }
    </style>
</head>
<body class="antialiased min-h-screen">
    <div id="app" class="min-h-screen flex flex-col" v-cloak>
        
        <transition enter-active-class="transform ease-out duration-300 transition" enter-from-class="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2" enter-to-class="translate-y-0 opacity-100 sm:translate-x-0" leave-active-class="transition ease-in duration-100" leave-from-class="opacity-100" leave-to-class="opacity-0">
            <div v-if="systemMessage" class="fixed top-5 right-5 z-50 max-w-md w-full bg-white shadow-soft rounded-lg pointer-events-auto border-l-4 overflow-hidden" 
                :class="{'border-success-500': systemMessage.type === 'success', 'border-sakura-500': systemMessage.type === 'error', 'border-primary-500': systemMessage.type === 'info'}">
                <div class="p-5 flex items-center">
                    <div class="flex-shrink-0">
                        <span v-if="systemMessage.type === 'success'" class="text-success-500 text-xl">âœ“</span>
                        <span v-if="systemMessage.type === 'error'" class="text-sakura-500 text-xl">!</span>
                        <span v-if="systemMessage.type === 'info'" class="text-primary-500 text-xl">i</span>
                    </div>
                    <div class="ml-4 w-0 flex-1">
                        <p class="text-base font-bold text-gray-900">{{ systemMessage.title || 'ç³»çµ±é€šçŸ¥' }}</p>
                        <p class="mt-1 text-sm text-gray-500">{{ systemMessage.text }}</p>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade-in" mode="out-in">
            <div v-if="currentView === 'auth'" class="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                    <div class="absolute -top-[10%] -left-[5%] w-[40%] h-[40%] rounded-full bg-primary-100/60 blur-3xl"></div>
                    <div class="absolute top-[50%] right-[0%] w-[35%] h-[35%] rounded-full bg-cream-200/50 blur-3xl"></div>
                </div>

                <div class="max-w-md w-full space-y-8 bg-white p-8 sm:p-12 rounded-xl shadow-soft relative z-10 border border-gray-200">
                    <div class="text-center">
                        <div class="mx-auto h-14 w-14 bg-primary-50 text-primary-500 rounded-xl flex items-center justify-center text-3xl border border-primary-100">ğŸ“–</div>
                        <h2 class="mt-6 text-3xl font-bold text-gray-900 tracking-tight">Focus Flow</h2>
                        <p class="mt-2 text-sm text-gray-500">ç¶²è·¯ç›£æ§ç³»çµ±</p>
                    </div>

                    <div class="flex border-b border-gray-200">
                        <button @click="switchAuth('login')" :class="authMode === 'login' ? 'border-primary-500 text-primary-600 font-bold' : 'border-transparent text-gray-400 hover:text-gray-600'" class="w-1/2 py-3 px-1 text-center border-b-2 text-base transition-colors duration-200">ç™»å…¥</button>
                        <button @click="switchAuth('register')" :class="authMode === 'register' ? 'border-primary-500 text-primary-600 font-bold' : 'border-transparent text-gray-400 hover:text-gray-600'" class="w-1/2 py-3 px-1 text-center border-b-2 text-base transition-colors duration-200">è¨»å†Š</button>
                    </div>

                    <form v-if="authMode === 'login'" @submit.prevent="handleLogin" class="mt-8 space-y-6 animate-slide-up">
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                                <input v-model="loginForm.email" type="text" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white transition text-base" placeholder="teacher@school.edu.tw">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">å¯†ç¢¼</label>
                                <input v-model="loginForm.password" type="password" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white transition text-base" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                            </div>
                        </div>
                        <button type="submit" :disabled="isLoading" class="w-full flex justify-center py-3 px-4 border border-transparent text-base font-bold rounded-lg text-white bg-primary-500 hover:bg-primary-600 transition shadow-sm disabled:opacity-70">
                            <span v-if="isLoading" class="spinner mr-3 border-white border-t-transparent"></span>
                            {{ isLoading ? 'ç™»å…¥ä¸­...' : 'é€²å…¥ç³»çµ±' }}
                        </button>
                    </form>

                    <form v-else @submit.prevent="handleRegister" class="mt-8 space-y-5 animate-slide-up">
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">å§“å</label><input type="text" v-model="registerForm.name" required class="block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white text-base" placeholder="é™³è€å¸«"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-2">é›»å­éƒµä»¶</label><input type="email" v-model="registerForm.email" required class="block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white text-base" placeholder="teacher@school.edu.tw"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-bold text-gray-700 mb-2">è¨­å®šå¯†ç¢¼</label><input type="password" v-model="registerForm.password" required class="block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white text-base"></div>
                            <div><label class="block text-sm font-bold text-gray-700 mb-2">ç¢ºèªå¯†ç¢¼</label><input type="password" v-model="registerForm.confirm" required class="block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white text-base"></div>
                        </div>
                        <button type="submit" :disabled="isLoading" class="w-full flex justify-center py-3 px-4 border border-transparent text-base font-bold rounded-lg text-white bg-success-600 hover:bg-success-500 transition shadow-sm disabled:opacity-70">{{ isLoading ? 'è™•ç†ä¸­...' : 'è¨»å†Šå¸³è™Ÿ' }}</button>
                    </form>
                </div>
            </div>

            <div v-else class="flex flex-col h-screen bg-gray-50 overflow-hidden">
                
                <header class="bg-white border-b border-gray-200 h-20 flex items-center justify-between px-8 shadow-sm z-20 flex-shrink-0">
                    <div class="flex items-center gap-8">
                        <div class="flex items-center gap-3 text-primary-500 font-bold text-2xl tracking-tight">
                            <span>ğŸ“–</span> Focus Flow
                        </div>
                        <div class="h-8 w-px bg-gray-300 mx-2"></div>
                        <div>
                            <h1 class="text-2xl font-bold tracking-tight text-gray-600">èª²å ‚çµæ®ºè€…</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-8">
                        <div class="flex items-center gap-4">
                             <div class="text-sm text-gray-600 bg-cream-50 border border-cream-200 px-4 py-1.5 rounded-full flex items-center gap-2.5">
                                <span class="w-2 h-2 rounded-full bg-success-500 animate-pulse"></span>
                                ç³»çµ±é€£ç·šæ­£å¸¸
                            </div>
                        </div>

                        <div class="flex items-center gap-4 pl-8 border-l border-gray-200">
                            <div class="text-right hidden sm:block">
                                <p class="text-base font-bold text-gray-800">{{ currentUser?.name }}</p>
                                <p class="text-sm text-primary-600 cursor-pointer hover:underline" @click="logout">ç™»å‡º</p>
                            </div>
                            <div class="w-11 h-11 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center font-bold text-lg border border-primary-200">
                                {{ currentUser ? currentUser.name.charAt(0) : 'T' }}
                            </div>
                        </div>
                    </div>
                </header>

                <main class="flex-1 overflow-y-auto p-6 md:p-10 space-y-8 w-full max-w-[1920px] mx-auto">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-card border border-gray-200 flex flex-col justify-between h-36">
                            <div class="flex justify-between items-start">
                                <p class="text-sm font-bold text-gray-500 uppercase tracking-wider">ç­ç´šäººæ•¸</p>
                                <div class="p-2 bg-primary-50 rounded-lg text-primary-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                            </div>
                            <h3 class="text-4xl font-bold text-gray-800">{{ students.length }}</h3>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-card border border-gray-200 flex flex-col justify-between h-36">
                            <div class="flex justify-between items-start">
                                <p class="text-sm font-bold text-gray-500 uppercase tracking-wider">é€£ç·šä¸­</p>
                                <div class="p-2 bg-success-50 rounded-lg text-success-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                            </div>
                            <h3 class="text-4xl font-bold text-success-600">{{ onlineCount }}</h3>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-card border border-gray-200 flex flex-col justify-between h-36">
                            <div class="flex justify-between items-start">
                                <p class="text-sm font-bold text-gray-500 uppercase tracking-wider">é›¢ç·š</p>
                                <div class="p-2 bg-gray-100 rounded-lg text-gray-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg></div>
                            </div>
                            <h3 class="text-4xl font-bold text-gray-400">{{ offlineCount }}</h3>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-card border border-gray-200 flex flex-col justify-between h-36 relative overflow-hidden">
                            <div v-if="violationCount > 0" class="absolute top-3 right-3 w-3 h-3 bg-sakura-500 rounded-full animate-pulse"></div>
                            <div class="flex justify-between items-start">
                                <p class="text-sm font-bold text-gray-500 uppercase tracking-wider">é•è¦</p>
                                <div class="p-2 bg-sakura-100 rounded-lg text-sakura-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                            </div>
                            <h3 class="text-4xl font-bold text-sakura-500">{{ violationCount }}</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[calc(100vh-280px)] min-h-[600px]">
                        
                        <div class="bg-white rounded-xl shadow-card border border-gray-200 flex flex-col h-full overflow-hidden">
                            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-cream-50/50">
                                <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
                                    <span class="text-primary-500">å­¸ç”Ÿç‹€æ…‹åˆ—è¡¨
                                </h2>
                                <div class="flex gap-3 text-sm">
                                    <button 
                                        @click="setFilter('all')"
                                        :class="currentFilter === 'all' ? 'bg-primary-50 text-primary-600 border-primary-200 font-bold' : 'bg-white text-gray-600 border-gray-200 hover:border-primary-500 hover:text-primary-600'"
                                        class="px-4 py-1.5 border rounded-lg transition shadow-sm">
                                        å…¨éƒ¨
                                    </button>
                                    <button 
                                        @click="setFilter('online')"
                                        :class="currentFilter === 'online' ? 'bg-primary-50 text-primary-600 border-primary-200 font-bold' : 'bg-white text-gray-600 border-gray-200 hover:border-primary-500 hover:text-primary-600'"
                                        class="px-4 py-1.5 border rounded-lg transition shadow-sm">
                                        åƒ…é¡¯ç¤ºé€£ç·šä¸­
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto">
                                <table class="min-w-full divide-y divide-gray-100">
                                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                            <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-gray-500 uppercase tracking-wider">å§“å / å­¸è™Ÿ</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-100 text-base">
                                        <tr v-for="student in filteredStudents" :key="student.student_id" class="hover:bg-cream-50 transition-colors duration-150 group">
                                            <td class="px-8 py-5 whitespace-nowrap">
                                                <span :class="getStatusBadgeClass(student)" class="px-3 py-1.5 inline-flex text-xs leading-5 font-bold rounded-full items-center gap-2 border">
                                                    <span class="w-2 h-2 rounded-full" :class="getStatusDotClass(student)"></span>
                                                        {{ student.status === 'online' ? 'é€£ç·šä¸­' : 'é›¢ç·š' }}
                                                </span>
                                            </td>
                                            <td class="px-8 py-5 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="h-10 w-10 rounded-lg bg-primary-50 text-primary-600 border border-primary-100 flex items-center justify-center font-bold text-base mr-4">
                                                        {{ getInitials(student.name) }}
                                                    </div>
                                                    <div>
                                                        <div class="text-base font-bold text-gray-800">{{ student.name }}</div>
                                                        <div class="text-sm text-gray-500">{{ student.student_id }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-8 py-5 whitespace-nowrap text-right">
                                                <span class="text-sm font-bold text-sakura-500" v-if="student.violation_count > 0">
                                                    é•è¦ {{ student.violation_count }} æ¬¡
                                                </span>
                                                <span class="text-sm text-gray-400" v-else>è¡¨ç¾å„ªè‰¯</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div v-if="filteredStudents.length === 0" class="p-8 text-center text-gray-400 text-sm">
                                    {{ isLoading ? 'è³‡æ–™è®€å–ä¸­...' : 'ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯é€£ç·š' }}
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col gap-6 h-full">
                            
                            <div class="bg-white rounded-xl shadow-card border border-gray-200 flex flex-col shrink-0 max-h-[55%] overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-100 bg-cream-50/50 flex justify-between items-center shrink-0">
                                    <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
                                        <span class="text-primary-500">AI åŠ©æ•™çŸ¥è­˜åº«
                                    </h2>
                                    <span class="text-xs bg-success-50 text-success-600 px-2.5 py-1 rounded-md border border-success-500/20 font-bold tracking-wide">
                                        RAG READY
                                    </span>
                                </div>
                                
                                <div class="p-6 flex flex-col flex-1 overflow-hidden">
                                    <div class="relative border-2 border-dashed border-primary-200 rounded-xl bg-gray-50 hover:bg-white hover:border-primary-400 transition-all duration-200 group cursor-pointer p-5 text-center shrink-0">
                                        <input type="file" @change="handleFileSelect" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" :disabled="isUploading">
                                        <div class="space-y-2 pointer-events-none">
                                            <div class="mx-auto w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-100 text-primary-300 group-hover:text-primary-500 group-hover:scale-110 transition-all">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                            </div>
                                            <p class="text-sm font-bold text-gray-700">é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³æ•™æ</p>
                                            <p class="text-xs text-gray-400">æ”¯æ´ PDF</p>
                                        </div>
                                    </div>

                                    <div class="mt-4 flex-1 overflow-y-auto pr-1 custom-scroll min-h-[80px]">
                                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ä¸Šå‚³ç´€éŒ„</h3>
                                        <ul class="space-y-2">
                                            <li v-for="(file, index) in uploadHistory" :key="index" class="flex items-center justify-between bg-gray-50 px-3 py-2.5 rounded-lg border border-gray-100 text-sm">
                                                <div class="flex items-center gap-3 overflow-hidden">
                                                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2 6 6 0 016 6v1H5a2 2 0 00-2 2v1H2v-1a4 4 0 014-4z" clip-rule="evenodd"></path></svg>
                                                    <span class="text-gray-700 truncate font-medium">{{ file.name }}</span>
                                                </div>
                                                <span class="text-gray-400 text-xs flex-shrink-0 ml-2 font-mono">{{ file.date }}</span>
                                            </li>
                                        </ul>
                                        <div v-if="uploadHistory.length === 0" class="text-center text-gray-400 text-xs py-2">
                                            å°šç„¡ä¸Šå‚³ç´€éŒ„
                                        </div>
                                    </div>

                                    <div v-if="isUploading" class="mt-4 pt-4 border-t border-gray-100 animate-fade-in shrink-0">
                                        <div class="flex justify-between text-sm mb-2">
                                            <span class="font-bold text-primary-600 flex items-center gap-2">
                                                <span class="w-2.5 h-2.5 rounded-full border-2 border-primary-500 border-t-transparent animate-spin"></span>
                                                æ­£åœ¨åˆ†æ...
                                            </span>
                                            <span class="font-mono text-primary-600 font-bold">{{ uploadProgress }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                            <div class="h-2 rounded-full bg-primary-500 transition-all duration-300 ease-out" :style="{ width: uploadProgress + '%' }"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-card border border-gray-200 flex flex-col flex-1 min-h-[250px] overflow-hidden">
                                <div class="px-6 py-4 border-b border-gray-100 bg-cream-50/50 flex items-center shrink-0">
                                    <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
                                        <span class="text-primary-500">ä¸èªçœŸæ’è¡Œæ¦œ</span>
                                    </h2>
                                </div>
                                
                                <div class="p-6 relative flex-1 w-full min-h-0">
                                    <canvas id="trafficChart"></canvas>
                                </div>
                            </div>

                        </div>
                    </div>
                </main>
            </div>
        </transition>
    </div>

    <script>
    const { createApp, ref, computed, nextTick } = Vue;
    
    createApp({
        setup() {
            const currentView = ref('auth');
            const authMode = ref('login'); 
            const isLoading = ref(false);
            const currentUser = ref(null);
            const systemMessage = ref(null);
            const currentFilter = ref('all');

            const loginForm = ref({ email: '', password: '' });
            const registerForm = ref({ name: '', email: '', password: '', confirm: '' });

            const students = ref([]); // å¾… API å¯«å…¥
            let trafficChart = null;
            let pollingInterval = null;

            const isUploading = ref(false);
            const uploadProgress = ref(0);
            const uploadHistory = ref([]); // ä¸Šå‚³ç´€éŒ„å·²æ¸…ç©º

            // Helper functions
            const getInitials = (name) => {
                if (!name) return '';
                if (/[\u4e00-\u9fa5]/.test(name)) return name.charAt(0);
                return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
            };

            const getStatusBadgeClass = (student) => {
                if (student.status !== 'online') return 'bg-gray-50 text-gray-500 border-gray-200';
                if (student.violation_count > 0) return 'bg-sakura-50 text-sakura-600 border-sakura-200';
                return 'bg-success-50 text-success-600 border-success-200';
            };
            
            const getStatusDotClass = (student) => {
                if (student.status !== 'online') return 'bg-gray-300';
                if (student.traffic > 1000) return 'bg-sakura-500';
                return 'bg-success-500';
            };

            const getProgressColor = (value) => {
                if (value > 1000) return 'bg-sakura-500';
                if (value > 500) return 'bg-primary-300';
                return 'bg-primary-500';
            };

            const showToast = (text, type = 'info', title = '') => {
                systemMessage.value = { text, type, title };
                setTimeout(() => systemMessage.value = null, 3000);
            };

            const switchAuth = (mode) => {
                authMode.value = mode;
                loginForm.value = { email: '', password: '' };
                registerForm.value = { name: '', email: '', password: '', confirm: '' };
            };

            const setFilter = (filter) => {
                currentFilter.value = filter;
            };

            const filteredStudents = computed(() => {
                if (currentFilter.value === 'online') {
                    return students.value.filter(s => s.status === 'online');
                }
                return students.value;
            });

            // ç™»å…¥
            const handleLogin = async () => {
                isLoading.value = true;
                try {
                    // æŒ‡å‘æ­£ç¢ºçš„å¾Œç«¯ Port 8000
                    const response = await fetch('http://127.0.0.1:8000/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loginForm.value)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // ç™»å…¥æˆåŠŸ
                        currentUser.value = data.user;
                        showToast('ç™»å…¥æˆåŠŸï¼', 'success', 'æ­¡è¿');
                        enterDashboard();
                    } else {
                        // ç™»å…¥å¤±æ•— (ä¾‹å¦‚ 401 éŒ¯èª¤)
                        showToast(data.detail || 'ç™»å…¥å¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error("é€£ç·šéŒ¯èª¤:", error);
                    showToast('ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ (è«‹ç¢ºèª Port 8000 æœ‰é–‹å•Ÿ)', 'error');
                } finally {
                    isLoading.value = false;
                }
            };

            const handleRegister = async () => {
                if(registerForm.value.password !== registerForm.value.confirm) {
                    showToast('è«‹ç¢ºèªå…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸€è‡´', 'error');
                    return;
                }
                isLoading.value = true;
    
                try {
                // æŒ‡å‘ 8000 port
                    const res = await fetch('http://127.0.0.1:8000/api/register', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: registerForm.value.name,
                            email: registerForm.value.email,
                            password: registerForm.value.password
                        })
                    });
        
                    const data = await res.json();
        
                    if(!res.ok) throw new Error(data.detail || 'è¨»å†Šå¤±æ•—');

                    showToast('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥', 'success');
                    authMode.value = 'login'; // åˆ‡æ›å›ç™»å…¥ç•«é¢
                    loginForm.value.email = registerForm.value.email;

                } catch(e) {
                    showToast(e.message, 'error');
                } finally {
                    isLoading.value = false;
                }
            };

            const logout = () => {
                if(trafficChart) { trafficChart.destroy(); trafficChart = null; }
                if(pollingInterval) clearInterval(pollingInterval);
                currentView.value = 'auth';
                authMode.value = 'login';
                currentUser.value = null;
                students.value = []; // ç™»å‡ºæ™‚æ¸…ç©ºè³‡æ–™
            };

            const enterDashboard = async () => {
                currentView.value = 'dashboard';
                await nextTick();
                setTimeout(() => {
                    fetchStudents(); 
                    initChart();     
                    updateChart();
                    fetchUploadHistory();
                    
                    // è¨­å®šè¼ªè©¢ï¼šæ¯ 2.5 ç§’è·Ÿå¾Œç«¯è¦ä¸€æ¬¡æœ€æ–°è³‡æ–™
                    pollingInterval = setInterval(() => { 
                        fetchStudents(); 
                        updateChart(); 
                    }, 2500);
                }, 100); 
            };

            // æ ¸å¿ƒé‚è¼¯ï¼šå¾å¾Œç«¯ç²å–å­¸ç”Ÿè³‡æ–™
            const fetchStudents = async () => {
                try {
                    // TODO: è«‹å°‡æ­¤è™• URL æ›¿æ›ç‚ºä½ çš„çœŸå¯¦å¾Œç«¯ API åœ°å€
                    // const response = await fetch('/api/students');
                    
                    /*
                    if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
                    const data = await response.json();
                    students.value = data; 
                    */
                   
                   // è‹¥å°šæœªæ¥é€šå¾Œç«¯ï¼Œæš«æ™‚ä¸åŸ·è¡Œä»»ä½•å‹•ä½œï¼Œé¿å…å ±éŒ¯
                   // console.log("æ­£åœ¨å˜—è©¦å¾ API ç²å–è³‡æ–™...");

                } catch (error) {
                    console.error("ç„¡æ³•å–å¾—å­¸ç”Ÿè³‡æ–™:", error);
                    // showToast('ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨', 'error');
                }
            };
            
            // å¾å¾Œç«¯ç²å–æ­·å²ä¸Šå‚³ç´€éŒ„
            const fetchUploadHistory = async () => {
                try {
                    const res = await fetch('http://127.0.0.1:8000/api/admin/files');
                    if (res.ok) {
                        const data = await res.json();
                        uploadHistory.value = data; 
                    }
                } catch (error) {
                    console.error("ç„¡æ³•è®€å–æ­·å²æª”æ¡ˆ:", error);
                }
            };

            const initChart = () => {
                const ctx = document.getElementById('trafficChart');
                if(!ctx) return;
                
                Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
                Chart.defaults.color = '#6B7280'; 
                
                trafficChart = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'é•è¦æ¬¡æ•¸',
                            data: [],
                            backgroundColor: [],
                            borderRadius: 6,
                            barPercentage: 0.65,
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 500 },
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { 
                                display: true,
                                grid: { display: false },
                                ticks: { stepSize: 1 }
                            },
                            y: { 
                                grid: { display: false }, 
                                ticks: { 
                                    font: { size: 14, weight: '500' },
                                    color: '#374151',
                                    autoSkip: false
                                } 
                            } 
                        }
                    }
                });
            };
            
            const updateChart = async () => {
                if(trafficChart && students.value.length > 0) {
                    // ä¾ç…§é•è¦æ¬¡æ•¸ (violation_count) ç”±å¤§åˆ°å°æ’åº
                    // å‰åå
                    const sorted = [...students.value]
                        .sort((a,b) => b.violation_count - a.violation_count)
                        .slice(0, 10);
                    
                    trafficChart.data.labels = sorted.map(d => d.name);
                    
                    // é•è¦è¶Šå¤šé¡è‰²è¶Šç´…
                    trafficChart.data.datasets[0].backgroundColor = sorted.map(d => {
                         if (d.violation_count >= 5) return '#D98E7D'; // æ·±ç´… (åš´é‡)
                         if (d.violation_count >= 1) return '#EBAA99'; // æ·ºç´… (è¼•å¾®)
                         return '#E0EBF5'; // è—ç° (ä¹–å¯¶å¯¶)
                    });
                    
                    // é•è¦æ¬¡æ•¸
                    trafficChart.data.datasets[0].data = sorted.map(d => d.violation_count);
                    trafficChart.update();
                }
            };

            // æª”æ¡ˆä¸Šå‚³
            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // å»ºç«‹ FormData ç‰©ä»¶ä¾†åŒ…è£æª”æ¡ˆ
                const formData = new FormData();
                formData.append('file', file);

                isUploading.value = true;
                uploadProgress.value = 10; // è®“é€²åº¦æ¢å…ˆè·‘ä¸€é»é»

                try {
                    // ç™¼é€ POST è«‹æ±‚åˆ°å¾Œç«¯ API
                    const response = await fetch('http://127.0.0.1:8000/api/admin/upload', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'ä¸Šå‚³å¤±æ•—');
                    }
                    
                    const data = await response.json();

                    // ä¸Šå‚³æˆåŠŸï¼šæ›´æ–°ä»‹é¢
                    uploadProgress.value = 100;
                    
                    setTimeout(() => {
                        const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                        // æ›´æ–°åˆ—è¡¨ (é¡¯ç¤ºå¾Œç«¯å›å‚³çš„è¨Šæ¯æˆ–æª”å)
                        uploadHistory.value.unshift({ 
                            name: file.name, 
                            date: today,
                            info: `çŸ¥è­˜åº«ç‰‡æ®µ: ${data.kb_size || 'N/A'}` 
                        });
                        showToast(`ä¸Šå‚³æˆåŠŸï¼å·²è¼‰å…¥æ•™æ`, 'success');
                        isUploading.value = false;
                    }, 500);

                } catch (error) {
                    console.error("ä¸Šå‚³éŒ¯èª¤:", error);
                    showToast(error.message, 'error');
                    isUploading.value = false;
                } finally {
                    e.target.value = '';
                }
            };

            const onlineCount = computed(() => students.value.filter(s => s.status === 'online').length);
            const offlineCount = computed(() => students.value.filter(s => s.status === 'offline').length);
            const violationCount = computed(() => students.value.filter(s => s.traffic > 1000).length);

            return { 
                currentView, authMode, isLoading, currentUser, systemMessage,
                loginForm, registerForm, switchAuth, handleLogin, handleRegister, logout,
                students, onlineCount, offlineCount, violationCount,
                isUploading, uploadProgress, uploadHistory, handleFileSelect,
                filteredStudents, currentFilter, setFilter,
                getInitials, getStatusBadgeClass, getStatusDotClass, getProgressColor
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
